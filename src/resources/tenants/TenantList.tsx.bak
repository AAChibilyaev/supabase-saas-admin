import {
  List,
  Datagrid,
  TextField,
  DateField,
  ChipField,
  NumberField,
  EditButton,
  ShowButton,
  FilterButton,
  CreateButton,
  TopToolbar,
  TextInput,
  SelectInput,
  usePermissions
} from 'react-admin'
import { Badge } from '../../components/ui/badge'
import { PermissionGate } from '../../components/permissions'
import { UserPermissions } from '../../types/permissions'
import { useRealtimeSubscription } from '../../hooks/useRealtimeSubscription'

const TenantListActions = () => {
  const { permissions } = usePermissions<UserPermissions>()

  return (
    <TopToolbar>
      <FilterButton />
      <PermissionGate resource="tenants" action="create">
        <CreateButton />
      </PermissionGate>
    </TopToolbar>
  )
}

const tenantFilters = [
  <TextInput key="search" label="Search" source="q" alwaysOn />,
  <SelectInput
    key="plan"
    source="plan_type"
    label="Plan"
    choices={[
      { id: 'free', name: 'Free' },
      { id: 'starter', name: 'Starter' },
      { id: 'pro', name: 'Pro' },
      { id: 'enterprise', name: 'Enterprise' }
    ]}
  />
]

const PlanField = ({ record }: { record?: any }) => {
  if (!record) return null

  const variant = record.plan_type === 'free' ? 'secondary' :
                  record.plan_type === 'enterprise' ? 'default' : 'outline'

  return <Badge variant={variant}>{record.plan_type}</Badge>
}

export const TenantList = () => {
  const { permissions } = usePermissions<UserPermissions>()

  // Enable real-time updates for tenants
  useRealtimeSubscription({
    resource: 'tenants',
    showNotifications: true,
  })

  return (
    <List
      filters={tenantFilters}
      actions={<TenantListActions />}
      perPage={25}
      sort={{ field: 'created_at', order: 'DESC' }}
    >
      <Datagrid rowClick="show" bulkActionButtons={false}>
        <TextField source="name" label="Tenant Name" />
        <TextField source="slug" label="Slug" />
        <PlanField source="plan_type" label="Plan" />
        <TextField source="custom_domain" label="Domain" />
        <DateField source="created_at" label="Created" showTime />
        <DateField source="billing_cycle_end" label="Billing Cycle End" />
        {permissions?.canAccess('tenants', 'edit') && <EditButton />}
        {permissions?.canAccess('tenants', 'show') && <ShowButton />}
      </Datagrid>
    </List>
  )
}
